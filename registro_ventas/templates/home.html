<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Pedido</title>
    <style>
        /* Ajuste de tamaño para los botones y el campo de entrada */
        .cantidad-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cantidad-container button {
            width: 30px;
            height: 30px;
            font-size: 18px;
            font-weight: bold;
        }

        #cantidad_bebidas {
            width: 40px;
            text-align: center;
            font-size: 16px;
            height: 30px;
        }
    </style>
    <script>
        const categoriasBebidas = {{ categorias_bebidas | safe }};

        function mostrarFormularios() {
            let cantidadBebidas = document.getElementById('cantidad_bebidas').value;
            let contenedor = document.getElementById('formularios_bebidas');
            contenedor.innerHTML = '';

            for (let i = 0; i < cantidadBebidas; i++) {
                contenedor.innerHTML += `
                    <div id="bebida_${i}">
                        <h3>Bebida ${i + 1}</h3>
                        
                        <label for="categoria_bebida_${i}">Categoría:</label>
                        <select id="categoria_bebida_${i}" name="categoria_bebida_${i}" onchange="mostrarSubcategorias(${i})">
                            <option value="">Selecciona una categoría</option>
                            ${Object.keys(categoriasBebidas).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select><br>
                        
                        <label for="subcategoria_bebida_${i}">Subcategoría:</label>
                        <select id="subcategoria_bebida_${i}" name="subcategoria_bebida_${i}">
                            <option value="">Selecciona una subcategoría</option>
                        </select><br>
                        
                        <label for="tipo_leche_${i}">Tipo de Leche:</label>
                        <select id="tipo_leche_${i}" name="tipo_leche_${i}">
                            <option value="Light">Light</option>
                            <option value="Deslactosada">Deslactosada</option>
                            <option value="Entera">Entera</option>
                        </select><br>
                        
                        <label for="azucar_${i}">¿Azúcar?:</label>
                        <select id="azucar_${i}" name="azucar_${i}">
                            <option value="Si">Sí</option>
                            <option value="No">No</option>
                        </select><br>
                        
                        <label for="consideraciones_${i}">Consideraciones:</label>
                        <input type="text" id="consideraciones_${i}" name="consideraciones_${i}"><br><br>
                    </div>
                `;
            }
        }

        function mostrarSubcategorias(index) {
            let categoria = document.getElementById(`categoria_bebida_${index}`).value;
            let subcategoriaSelect = document.getElementById(`subcategoria_bebida_${index}`);
            subcategoriaSelect.innerHTML = '<option value="">Selecciona una subcategoría</option>';

            if (categoria && categoriasBebidas[categoria]) {
                categoriasBebidas[categoria].forEach(subcategoria => {
                    subcategoriaSelect.innerHTML += `<option value="${subcategoria}">${subcategoria}</option>`;
                });
            }
        }

        function actualizarCantidad(incremento) {
            let cantidadBebidasInput = document.getElementById('cantidad_bebidas');
            let cantidadBebidas = parseInt(cantidadBebidasInput.value);

            if (isNaN(cantidadBebidas)) cantidadBebidas = 1;

            if (incremento === 1 || (incremento === -1 && cantidadBebidas > 1)) {
                cantidadBebidas += incremento;
                cantidadBebidasInput.value = cantidadBebidas;
            }

            mostrarFormularios();
        }

        function obtenerUbicacion() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latitud = position.coords.latitude;
                        const longitud = position.coords.longitude;

                        fetch("/guardar_ubicacion", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ latitud, longitud })
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert("Ubicación enviada correctamente: " + data.message);
                        })
                        .catch(error => {
                            console.error("Error al enviar la ubicación:", error);
                        });
                    },
                    function(error) {
                        console.error("Error obteniendo la ubicación:", error);
                    }
                );
            } else {
                alert("La geolocalización no está soportada por este navegador.");
            }
        }
    </script>
</head>

<body>

    <h1>Registro de Pedido</h1>

    <button onclick="obtenerUbicacion()">Envíar ubicación actual</button><br><br>

    <form method="POST" action="/{{ token }}">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombre" required><br><br>

        <label for="cantidad_bebidas">¿Cuántas bebidas deseas?</label>

        <div class="cantidad-container">
            <!-- Botón de restar bebidas -->
            <button type="button" onclick="actualizarCantidad(-1)">-</button>
            
            <!-- Input de cantidad de bebidas -->
            <input type="number" id="cantidad_bebidas" name="cantidad_bebidas" min="1" value="1" readonly>
            
            <!-- Botón de añadir bebidas -->
            <button type="button" onclick="actualizarCantidad(1)">+</button>
        </div>

        <button type="button" onclick="mostrarFormularios()">Click para personalizar tus bebidas</button><br><br>

        <div id="formularios_bebidas"></div>

        <br>
        
        <button type="submit">Hacer Pedido</button>
    </form>
</body>
</html>
